name: release to github

on:
  push:
    tags:
      - "*.*.*"

jobs:
  doc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: 'Get Previous tag'
        id: previoustag
        uses: "WyriHaximus/github-action-get-previous-tag@v1"
      - name: 'Get previous release tag'
        id: tag
        uses: "sammcoe/get-previous-release-action@v1"
      - name: replace version
        run: sed -i "s/${{steps.tag.outputs.tag}}/${{steps.previoustag.outputs.tag}}/g" README*.md
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: Update README file.
          author: GitHub <noreply@github.com>
          signoff: false
          branch: doc/${{steps.previoustag.outputs.tag}}
          labels: document
          base: main
          delete-branch: true
          title: 'doc: update README files version to ${{steps.previoustag.outputs.tag}}'
          body: |
            **åœ¨æå‡ºæ­¤æ‹‰å–è¯·æ±‚æ—¶ï¼Œæˆ‘ç¡®è®¤äº†ä»¥ä¸‹å‡ ç‚¹ï¼ˆä¿å­˜åè¯·ç‚¹å‡»å¤é€‰æ¡†ï¼‰ï¼š**

            - [x] æ ‡é¢˜ä¸ºfixã€featæˆ–docå¼€å¤´
            - [x] æˆ‘å·²æ£€æŸ¥æ²¡æœ‰ä¸æ­¤è¯·æ±‚é‡å¤çš„æ‹‰å–è¯·æ±‚ã€‚
            - [x] æˆ‘å·²ç»è€ƒè™‘è¿‡ï¼Œå¹¶ç¡®è®¤è¿™ä»½å‘ˆä»¶å¯¹å…¶ä»–äººå¾ˆæœ‰ä»·å€¼ã€‚
            - [x] æˆ‘æ¥å—æ­¤æäº¤å¯èƒ½ä¸ä¼šè¢«ä½¿ç”¨ï¼Œå¹¶æ ¹æ®ç»´æŠ¤äººå‘˜çš„æ„æ„¿å…³é—­æ‹‰å–è¯·æ±‚ã€‚

            **å¡«å†™PRå†…å®¹ï¼š**

            - Update README files version to latest tag by bot ğŸš€.

          draft: false
      - name: Auto approve
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: juliangruber/approve-pull-request-action@v1
        with:
          github-token: ${{ secrets.PAT }}
          number: ${{ steps.cpr.outputs.pull-request-number }}
      - id: automerge
        name: automerge
        uses: "pascalgn/automerge-action@v0.15.3"
        env:
          MERGE_LABELS: "document"
          MERGE_DELETE_BRANCH: true
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          PULL_REQUEST: ${{ steps.cpr.outputs.pull-request-number }}
          MERGE_RETRIES: 18
          MERGE_RETRY_SLEEP: 10000

  test:
    needs: doc
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 8
        uses: actions/setup-java@v2
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: maven
      - run: sed -i "s/SONIC_REMOTE_TEST_URL/${{ secrets.REMOTE_TEST_URL }}/g" src/test/java/org/cloud/sonic/driver/ios/IOSDriverTest.java
      - run: sed -i "s/SONIC_REMOTE_TEST_URL/${{ secrets.REMOTE_TEST_URL }}/g" src/test/java/org/cloud/sonic/driver/ios/service/WdaClientTest.java
      - name: Validate and Compile with Maven
        run: mvn cobertura:cobertura
      - name: upload codecov
        uses: codecov/codecov-action@v3.1.0
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  release:
    needs: [ doc,test ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: 'Get Previous tag'
        id: previoustag
        uses: "WyriHaximus/github-action-get-previous-tag@v1"
      - name: replace version
        run: sed -i "s/SONIC_VERSION/${{ steps.previoustag.outputs.tag }}/g" pom.xml
      - name: Set up Maven Central Repo
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
          server-id: sonatype-nexus-staging
          server-username: ${{ secrets.OSSRH_USER }}
          server-password: ${{ secrets.OSSRH_PASSWORD }}
          gpg-passphrase: ${{ secrets.GPG_PASSWORD }}
      - name: Publish to Maven Central Repo
        uses: samuelmeuli/action-maven-publish@v1
        with:
          maven_args: -Dmaven.test.skip=true
          gpg_private_key: ${{ secrets.GPG_SECRET }}
          gpg_passphrase: ${{ secrets.GPG_PASSWORD }}
          nexus_username: ${{ secrets.OSSRH_USER }}
          nexus_password: ${{ secrets.OSSRH_PASSWORD }}
      - uses: softprops/action-gh-release@v1
        with:
          draft: false
          generate_release_notes: true
